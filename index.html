<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academia de Agentes - Plataforma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app"></div>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://rynoddtiaxbnyjspokpz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bm9kZHRpYXhibnlqc3Bva3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNDkwNjcsImV4cCI6MjA4MDYyNTA2N30.4ioySNGorwcnayfYm5a5V-w9Jv99N3k8i5K_rZ-zf1E';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        const NICHES = [
            { id: 'parques-tematicos', name: 'PARQUES TEM√ÅTICOS' },
            { id: 'playa-todo-incluido', name: 'PLAYA Y TODO INCLUIDO' },
            { id: 'cruceros', name: 'CRUCEROS' },
            { id: 'bodas-lunas-miel', name: 'BODAS Y LUNAS DE MIEL' },
            { id: 'europa', name: 'EUROPA' },
            { id: 'asia', name: 'ASIA' },
            { id: 'viajes-deportivos', name: 'VIAJES DEPORTIVOS' },
            { id: 'viajes-religiosos', name: 'VIAJES RELIGIOSOS' },
            { id: 'aventura-ecoturismo', name: 'AVENTURA Y ECOTURISMO' },
            { id: 'ski-montana', name: 'SKI Y MONTA√ëA' }
        ];

        let currentUser = null;
        let currentProfile = null;
        let currentView = 'login';

        async function init() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (user) {
                currentUser = user;
                await loadProfile(user.id);
            }
            render();
        }

        async function loadProfile(userId) {
            console.log('Cargando perfil para:', userId);
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                console.log('Perfil cargado:', { data, error });
                
                if (error) {
                    console.error('Error al cargar perfil:', error);
                    alert('Error al cargar perfil: ' + error.message);
                    return;
                }
                
                if (data) {
                    currentProfile = data;
                    if (data.role === 'admin') {
                        currentView = 'admin';
                    } else if (!data.has_completed_welcome) {
                        currentView = 'welcome';
                    } else if (!data.niche_id) {
                        currentView = 'niche-selection';
                    } else {
                        currentView = 'dashboard';
                    }
                }
            } catch (err) {
                console.error('Error inesperado en loadProfile:', err);
                alert('Error inesperado al cargar perfil: ' + err.message);
            }
        }

        async function handleLogin(email, password) {
            console.log('Intentando login con:', email);
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ 
                    email: email, 
                    password: password 
                });
                
                console.log('Respuesta de login:', { data, error });
                
                if (error) {
                    alert('Error de inicio de sesi√≥n: ' + error.message);
                    return;
                }
                
                if (data.user) {
                    currentUser = data.user;
                    await loadProfile(data.user.id);
                    render();
                } else {
                    alert('No se pudo obtener el usuario');
                }
            } catch (err) {
                console.error('Error en handleLogin:', err);
                alert('Error inesperado: ' + err.message);
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            currentProfile = null;
            currentView = 'login';
            render();
        }

        async function updateNiche(nicheId) {
            const { error } = await supabaseClient
                .from('profiles')
                .update({ niche_id: nicheId })
                .eq('id', currentProfile.id);
            
            if (!error) {
                currentProfile.niche_id = nicheId;
                currentView = 'dashboard';
                render();
            }
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!currentUser) {
                app.innerHTML = renderLogin();
            } else if (currentView === 'niche-selection') {
                app.innerHTML = renderNicheSelection();
            } else if (currentView === 'admin') {
                app.innerHTML = renderAdmin();
            } else if (currentView === 'dashboard') {
                app.innerHTML = renderDashboard();
            } else if (currentView === 'welcome') {
                app.innerHTML = renderWelcome();
            }
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <h2 class="text-3xl font-bold text-center text-indigo-600 mb-6">Academia de Agentes</h2>
                        <p class="text-center text-gray-600 mb-8">Plataforma de capacitaci√≥n para agentes de viajes</p>
                        
                        <form onsubmit="handleLoginSubmit(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input 
                                    type="email" 
                                    id="email" 
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                                <input 
                                    type="password" 
                                    id="password" 
                                    required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                />
                            </div>
                            <button 
                                type="submit"
                                class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition"
                            >
                                Iniciar Sesi√≥n
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderNicheSelection() {
            const nichesHTML = NICHES.map(niche => `
                <button 
                    onclick="selectNiche('${niche.id}')"
                    class="p-6 border-2 border-gray-300 rounded-xl text-left hover:border-indigo-500 hover:bg-indigo-50 transition"
                >
                    <h3 class="font-semibold text-lg">${niche.name}</h3>
                </button>
            `).join('');

            const firstName = currentProfile?.full_name?.split(' ')[0] || 'Agente';

            return `
                <nav class="bg-white shadow-md mb-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center h-16">
                            <h1 class="text-2xl font-bold text-indigo-600">Academia de Agentes</h1>
                            <div class="flex items-center gap-4">
                                <span class="text-gray-700">${currentProfile?.email}</span>
                                <button onclick="handleLogout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                                    Cerrar Sesi√≥n
                                </button>
                            </div>
                        </div>
                    </div>
                </nav>
                <div class="max-w-4xl mx-auto p-6">
                    <div class="bg-white rounded-2xl shadow-xl p-8">
                        <h2 class="text-3xl font-bold text-indigo-600 mb-4">¬°Hola, ${firstName}!</h2>
                        <p class="text-gray-600 mb-8">Selecciona tu Nicho - Elige el nicho de viajes en el que te especializar√°s.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${nichesHTML}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWelcome() {
            const firstName = currentProfile?.full_name?.split(' ')[0] || 'Agente';
            return `
                <nav class="bg-white shadow-md mb-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center h-16">
                            <h1 class="text-2xl font-bold text-indigo-600">Academia de Agentes</h1>
                            <div class="flex items-center gap-4">
                                <span class="text-gray-700">${currentProfile?.email}</span>
                                <button onclick="handleLogout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                                    Cerrar Sesi√≥n
                                </button>
                            </div>
                        </div>
                    </div>
                </nav>
                <div class="max-w-6xl mx-auto p-6">
                    <div class="bg-white rounded-2xl shadow-xl p-8">
                        <h2 class="text-3xl font-bold text-indigo-600 mb-4">¬°Bienvenid@, ${firstName}!</h2>
                        <p class="text-gray-600 mb-6">Completa estos videos de bienvenida para comenzar tu capacitaci√≥n.</p>
                        <div id="welcome-videos" class="mb-6">
                            <p class="text-gray-500">Cargando videos...</p>
                        </div>
                    </div>
                </div>
                <script>loadWelcomeVideos();</script>
            `;
        }

        async function loadWelcomeVideos() {
            const container = document.getElementById('welcome-videos');
            const { data: videos, error } = await supabaseClient
                .from('videos')
                .select('*')
                .eq('folder_type', 'welcome')
                .order('order_index');
            
            if (error || !videos || videos.length === 0) {
                container.innerHTML = '<p class="text-gray-600">Por favor, espera a que el administrador suba videos de bienvenida.</p>';
                return;
            }

            const { data: progressData } = await supabaseClient
                .from('video_progress')
                .select('*')
                .eq('user_id', currentProfile.id);
            
            const progressMap = {};
            if (progressData) {
                progressData.forEach(p => {
                    progressMap[p.video_id] = p;
                });
            }

            let currentVideoIndex = 0;
            for (let i = 0; i < videos.length; i++) {
                if (!progressMap[videos[i].id]?.completed) {
                    currentVideoIndex = i;
                    break;
                }
                if (i === videos.length - 1) {
                    currentVideoIndex = i;
                }
            }

            const currentVideo = videos[currentVideoIndex];
            const allCompleted = videos.every(v => progressMap[v.id]?.completed);

            container.innerHTML = `
                <div class="aspect-video bg-gray-900 rounded-lg mb-4 overflow-hidden">
                    <iframe
                        src="https://drive.google.com/file/d/${currentVideo.drive_file_id}/preview"
                        className="w-full h-full"
                        allow="autoplay"
                        style="width: 100%; height: 100%; border: none;"
                    ></iframe>
                </div>
                <h3 class="text-xl font-semibold mb-2">${currentVideo.title}</h3>
                <p class="text-gray-600 mb-4">${currentVideo.description || ''}</p>
                
                ${!progressMap[currentVideo.id]?.completed ? `
                    <button
                        onclick="markWelcomeVideoComplete('${currentVideo.id}')"
                        class="px-6 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition"
                    >
                        Marcar como completado
                    </button>
                ` : ''}

                <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    ${videos.map((video, index) => `
                        <div
                            onclick="selectWelcomeVideo(${index}, ${JSON.stringify(video.id)}, ${progressMap[video.id]?.completed || false})"
                            class="p-4 border-2 rounded-lg cursor-pointer transition ${
                                currentVideo.id === video.id
                                    ? 'border-indigo-500 bg-indigo-50'
                                    : progressMap[video.id]?.completed
                                    ? 'border-green-500 bg-green-50'
                                    : 'border-gray-300 hover:border-indigo-300'
                            }"
                        >
                            <div class="flex items-center justify-between">
                                <span class="font-medium">${video.title}</span>
                                ${progressMap[video.id]?.completed ? '<span class="text-green-500 text-xl">‚úì</span>' : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>

                ${allCompleted ? `
                    <button
                        onclick="completeWelcome()"
                        class="mt-6 w-full px-6 py-4 bg-indigo-600 text-white rounded-lg font-semibold text-lg hover:bg-indigo-700 transition"
                    >
                        Continuar a selecci√≥n de nicho ‚Üí
                    </button>
                ` : ''}
            `;
        }

        window.loadWelcomeVideos = loadWelcomeVideos;

        window.selectWelcomeVideo = async function(index, videoId, completed) {
            if (index === 0 || completed) {
                await loadWelcomeVideos();
            }
        };

        window.markWelcomeVideoComplete = async function(videoId) {
            const { error } = await supabaseClient
                .from('video_progress')
                .upsert({
                    user_id: currentProfile.id,
                    video_id: videoId,
                    progress_percent: 100,
                    completed: true
                });
            
            if (!error) {
                await loadWelcomeVideos();
            }
        };

        function renderDashboard() {
            const niche = NICHES.find(n => n.id === currentProfile.niche_id);
            return `
                <nav class="bg-white shadow-md mb-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center h-16">
                            <h1 class="text-2xl font-bold text-indigo-600">Academia de Agentes</h1>
                            <div class="flex items-center gap-4">
                                <span class="text-gray-700">${currentProfile?.email}</span>
                                <span class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm font-medium">Agente</span>
                                <button onclick="handleLogout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                                    Cerrar Sesi√≥n
                                </button>
                            </div>
                        </div>
                    </div>
                </nav>
                <div class="max-w-7xl mx-auto p-6">
                    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                        <h2 class="text-2xl font-bold mb-4">Mi Nicho: ${niche?.name}</h2>
                        <p class="text-gray-600 mb-4">Tus videos de capacitaci√≥n aparecer√°n aqu√≠ una vez que el administrador los suba.</p>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-blue-800">üìπ El administrador debe agregar videos desde el panel de administraci√≥n.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdmin() {
            return `
                <nav class="bg-white shadow-md mb-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center h-16">
                            <h1 class="text-2xl font-bold text-indigo-600">Academia de Agentes</h1>
                            <div class="flex items-center gap-4">
                                <span class="text-gray-700">${currentProfile?.email}</span>
                                <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">Admin</span>
                                <button onclick="handleLogout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                                    Cerrar Sesi√≥n
                                </button>
                            </div>
                        </div>
                    </div>
                </nav>
                <div class="max-w-7xl mx-auto p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <button onclick="showAdminView('users')" class="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition">
                            <h3 class="text-xl font-bold text-indigo-600 mb-2">üë• Gesti√≥n de Usuarios</h3>
                            <p class="text-gray-600">Ver y administrar todos los usuarios registrados</p>
                        </button>
                        <button onclick="showAdminView('videos')" class="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition">
                            <h3 class="text-xl font-bold text-indigo-600 mb-2">üé¨ Gesti√≥n de Videos</h3>
                            <p class="text-gray-600">Agregar y administrar videos de capacitaci√≥n</p>
                        </button>
                    </div>
                    <div id="admin-content" class="bg-white rounded-2xl shadow-xl p-8">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">Panel de Administraci√≥n</h2>
                        <p class="text-gray-600">Selecciona una opci√≥n arriba para comenzar.</p>
                    </div>
                </div>
            `;
        }

        async function showAdminView(view) {
            const content = document.getElementById('admin-content');
            if (view === 'users') {
                const { data: users } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                const usersHTML = users.map(user => {
                    const niche = NICHES.find(n => n.id === user.niche_id);
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4">${user.email}</td>
                            <td class="p-4">
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">
                                    ${user.role}
                                </span>
                            </td>
                            <td class="p-4">${niche?.name || 'Sin asignar'}</td>
                            <td class="p-4">${user.has_completed_welcome ? '‚úì Completada' : '‚è≥ Pendiente'}</td>
                            <td class="p-4 text-sm text-gray-500">${new Date(user.created_at).toLocaleDateString()}</td>
                        </tr>
                    `;
                }).join('');

                content.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">Gesti√≥n de Usuarios</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b-2">
                                    <th class="text-left p-4">Email</th>
                                    <th class="text-left p-4">Rol</th>
                                    <th class="text-left p-4">Nicho</th>
                                    <th class="text-left p-4">Bienvenida</th>
                                    <th class="text-left p-4">Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${usersHTML}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (view === 'videos') {
                const { data: videos } = await supabaseClient
                    .from('videos')
                    .select('*')
                    .order('order_index');

                const videosHTML = videos ? videos.map(video => {
                    const niche = NICHES.find(n => n.id === video.niche_id);
                    return `
                        <div class="border rounded-lg p-4 hover:bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-lg">${video.title}</h3>
                                    <p class="text-gray-600 text-sm mb-2">${video.description || 'Sin descripci√≥n'}</p>
                                    <div class="flex gap-4 text-sm text-gray-500">
                                        <span>Tipo: <span class="font-medium">${video.folder_type}</span></span>
                                        ${video.niche_id ? `<span>Nicho: <span class="font-medium">${niche?.name}</span></span>` : ''}
                                        <span>Orden: <span class="font-medium">${video.order_index}</span></span>
                                    </div>
                                </div>
                                <button onclick="deleteVideo('${video.id}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm">
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('') : '<p class="text-gray-500">No hay videos agregados a√∫n.</p>';

                const nichesOptions = NICHES.map(n => `<option value="${n.id}">${n.name}</option>`).join('');

                content.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">Agregar Nuevo Video</h2>
                    <form onsubmit="handleAddVideo(event)" class="mb-8 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo</label>
                                <input type="text" id="video-title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ID del archivo de Drive</label>
                                <input type="text" id="video-drive-id" required placeholder="Ej: 1a2B3c4D5e6F7g8H9i0J" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de carpeta</label>
                                <select id="video-folder-type" onchange="toggleNicheField()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="welcome">Bienvenida</option>
                                    <option value="basics">B√°sico para empezar</option>
                                    <option value="niche">Nicho espec√≠fico</option>
                                    <option value="general">General (todos)</option>
                                </select>
                            </div>
                            <div id="niche-field" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nicho</label>
                                <select id="video-niche" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Seleccionar...</option>
                                    ${nichesOptions}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Orden</label>
                                <input type="number" id="video-order" value="1" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" />
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                            <textarea id="video-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 resize-none"></textarea>
                        </div>
                        <button type="submit" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition">
                            Agregar Video
                        </button>
                    </form>

                    <h2 class="text-2xl font-bold mb-6">Videos Existentes</h2>
                    <div class="space-y-4">
                        ${videosHTML}
                    </div>
                `;
            }
        }

        window.toggleNicheField = function() {
            const folderType = document.getElementById('video-folder-type').value;
            const nicheField = document.getElementById('niche-field');
            nicheField.style.display = folderType === 'niche' ? 'block' : 'none';
        };

        window.handleAddVideo = async function(e) {
            e.preventDefault();
            const video = {
                title: document.getElementById('video-title').value,
                description: document.getElementById('video-description').value,
                drive_file_id: document.getElementById('video-drive-id').value,
                folder_type: document.getElementById('video-folder-type').value,
                order_index: parseInt(document.getElementById('video-order').value),
                niche_id: document.getElementById('video-niche')?.value || null
            };

            const { error } = await supabaseClient.from('videos').insert(video);
            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert('Video agregado exitosamente');
                showAdminView('videos');
            }
        };

        window.deleteVideo = async function(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este video?')) return;
            const { error } = await supabaseClient.from('videos').delete().eq('id', id);
            if (!error) {
                alert('Video eliminado');
                showAdminView('videos');
            }
        };

        window.handleLoginSubmit = function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // Mostrar indicador de carga
            const button = e.target.querySelector('button[type="submit"]');
            button.textContent = 'Iniciando sesi√≥n...';
            button.disabled = true;
            
            handleLogin(email, password).finally(() => {
                button.textContent = 'Iniciar Sesi√≥n';
                button.disabled = false;
            });
        };

        window.handleLogout = handleLogout;
        
        window.selectNiche = function(nicheId) {
            updateNiche(nicheId);
        };

        window.completeWelcome = async function() {
            await supabaseClient
                .from('profiles')
                .update({ has_completed_welcome: true })
                .eq('id', currentProfile.id);
            currentProfile.has_completed_welcome = true;
            currentView = 'niche-selection';
            render();
        };

        window.showAdminView = showAdminView;

        // Iniciar la aplicaci√≥n
        init();
    </script>
</body>
</html>
