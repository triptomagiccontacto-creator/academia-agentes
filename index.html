<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academia de Agentes - Plataforma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#063573',
                        secondary: '#2594D9',
                        accent: '#F2C4C8',
                        highlight: '#F2D479'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-pink-50 min-h-screen">
    <div id="app"></div>

    <script>
        const SUPABASE_URL = 'https://rynoddtiaxbnyjspokpz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bm9kZHRpYXhibnlqc3Bva3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNDkwNjcsImV4cCI6MjA4MDYyNTA2N30.4ioySNGorwcnayfYm5a5V-w9Jv99N3k8i5K_rZ-zf1E';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const NICHES = [
            { id: 'parques-tematicos', name: 'PARQUES TEM√ÅTICOS', folder: 'Parques Tem√°ticos' },
            { id: 'playa-todo-incluido', name: 'PLAYA Y TODO INCLUIDO', folder: 'Playa y All Inclusive' },
            { id: 'cruceros', name: 'CRUCEROS', folder: 'Cruceros' },
            { id: 'bodas-lunas-miel', name: 'BODAS Y LUNAS DE MIEL', folder: 'Bodas y Lunas de miel' },
            { id: 'europa', name: 'EUROPA', folder: 'Europa' },
            { id: 'asia', name: 'ASIA', folder: 'Asia' },
            { id: 'viajes-deportivos', name: 'VIAJES DEPORTIVOS', folder: 'Viajes Deportivos' },
            { id: 'viajes-religiosos', name: 'VIAJES RELIGIOSOS', folder: 'Viajes Religiosos' },
            { id: 'aventura-ecoturismo', name: 'AVENTURA Y ECOTURISMO', folder: 'Aventura y Ecoturismo' },
            { id: 'ski-montana', name: 'SKI Y MONTA√ëA', folder: 'Ski y Monta√±a' }
        ];

        const FOLDERS = [
            { id: 'welcome', name: 'Bienvenida', type: 'welcome', order: 1 },
            { id: 'basics', name: 'B√°sico para empezar', type: 'basics', order: 2 },
            { id: 'general', name: 'General', type: 'general', order: 999 }
        ];

        let currentUser = null;
        let currentProfile = null;
        let currentView = 'login';
        let viewAsAgent = false;
        let selectedFolder = null;
        let videoProgressTracking = {};

        async function init() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    currentUser = user;
                    await loadProfile(user.id);
                }
            } catch (error) {
                console.error('Error en init:', error);
            }
            render();
        }

        async function loadProfile(userId) {
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) throw error;
                
                if (data) {
                    currentProfile = data;
                    
                    if (data.role === 'admin' && !viewAsAgent) {
                        currentView = 'admin';
                    } else {
                        currentView = 'dashboard';
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Error al cargar perfil');
            }
        }

        async function handleLogin(email, password) {
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                if (data.user) {
                    currentUser = data.user;
                    await loadProfile(data.user.id);
                    render();
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            currentProfile = null;
            currentView = 'login';
            viewAsAgent = false;
            selectedFolder = null;
            render();
        }

        function goToHome() {
            selectedFolder = null;
            viewAsAgent = false;
            if (currentProfile.role === 'admin') {
                currentView = 'admin';
            } else {
                currentView = 'dashboard';
            }
            render();
        }

        function toggleViewAsAgent() {
            viewAsAgent = !viewAsAgent;
            selectedFolder = null;
            if (viewAsAgent) {
                currentView = 'dashboard';
            } else {
                currentView = 'admin';
            }
            render();
        }

        function renderNav() {
            const firstName = currentProfile?.full_name?.split(' ')[0] || currentProfile?.email?.split('@')[0] || 'Usuario';
            const isAdmin = currentProfile?.role === 'admin';
            
            return `
                <nav class="bg-white shadow-md border-b-4 border-primary">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center h-16">
                            <button onclick="goToHome()" class="text-2xl font-bold text-primary hover:text-secondary transition">
                                Academia de Agentes
                            </button>
                            <div class="flex items-center gap-4">
                                ${currentView !== 'admin' ? `
                                    <span class="text-gray-700">Hola, <strong>${firstName}</strong></span>
                                ` : `
                                    <span class="text-gray-700">${currentProfile?.email}</span>
                                `}
                                ${isAdmin ? `
                                    <span class="px-3 py-1 bg-highlight text-primary rounded-full text-sm font-medium">Admin</span>
                                    ${viewAsAgent ? `
                                        <button onclick="toggleViewAsAgent()" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-primary transition text-sm">
                                            Volver a Admin
                                        </button>
                                    ` : ''}
                                ` : `
                                    <span class="px-3 py-1 bg-accent text-primary rounded-full text-sm font-medium">Agente</span>
                                `}
                                <button onclick="handleLogout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                                    Cerrar Sesi√≥n
                                </button>
                            </div>
                        </div>
                    </div>
                </nav>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!currentUser) {
                app.innerHTML = renderLogin();
            } else {
                let content = '';
                if (currentView === 'dashboard') {
                    if (selectedFolder) {
                        renderFolderVideos(selectedFolder).then(html => {
                            const appDiv = document.getElementById('app');
                            if (appDiv) appDiv.innerHTML = renderNav() + html;
                        });
                        return;
                    } else {
                        renderDashboard().then(html => {
                            const appDiv = document.getElementById('app');
                            if (appDiv) appDiv.innerHTML = renderNav() + html;
                        });
                        return;
                    }
                } else if (currentView === 'admin') {
                    content = renderAdmin();
                }
                
                app.innerHTML = renderNav() + content;
            }
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border-t-4 border-primary">
                        <h2 class="text-3xl font-bold text-center text-primary mb-6">Academia de Agentes</h2>
                        <p class="text-center text-gray-600 mb-8">Plataforma de capacitaci√≥n para agentes de viajes</p>
                        
                        <form onsubmit="handleLoginSubmit(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                                <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary" />
                            </div>
                            <button type="submit" class="w-full bg-secondary text-white py-3 rounded-lg font-semibold hover:bg-primary transition">
                                Iniciar Sesi√≥n
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        async function renderDashboard() {
            const { data: progressData } = await supabaseClient
                .from('video_progress')
                .select('video_id, completed')
                .eq('user_id', currentProfile.id)
                .eq('completed', true);

            const completedVideoIds = progressData ? progressData.map(p => p.video_id) : [];

            const { data: welcomeVideos } = await supabaseClient
                .from('videos')
                .select('id')
                .eq('folder_type', 'welcome');

            const { data: basicsVideos } = await supabaseClient
                .from('videos')
                .select('id')
                .eq('folder_type', 'basics');

            const welcomeComplete = welcomeVideos && welcomeVideos.length > 0 ? 
                welcomeVideos.every(v => completedVideoIds.includes(v.id)) : false;
            
            const basicsComplete = basicsVideos && basicsVideos.length > 0 ? 
                basicsVideos.every(v => completedVideoIds.includes(v.id)) : false;

            const firstName = currentProfile?.full_name?.split(' ')[0] || currentProfile?.email?.split('@')[0] || 'Agente';

            let folders = [...FOLDERS];
            
            if (currentProfile.niche_id) {
                const niche = NICHES.find(n => n.id === currentProfile.niche_id);
                if (niche) {
                    folders.splice(2, 0, {
                        id: 'niche',
                        name: niche.folder,
                        type: 'niche',
                        order: 3,
                        niche_id: currentProfile.niche_id
                    });
                }
            }

            const foldersHTML = await Promise.all(folders.map(async folder => {
                let isLocked = false;
                let lockMessage = '';
                
                if (folder.type === 'basics' && !welcomeComplete) {
                    isLocked = true;
                    lockMessage = 'Completa "Bienvenida" para desbloquear';
                } else if (folder.type === 'niche' && !basicsComplete) {
                    isLocked = true;
                    lockMessage = 'Completa "B√°sico para empezar" para desbloquear';
                } else if (folder.type === 'general' && !basicsComplete) {
                    isLocked = true;
                    lockMessage = 'Completa "B√°sico para empezar" para desbloquear';
                }

                let videoCount = 0;
                if (folder.type === 'niche') {
                    const { count } = await supabaseClient
                        .from('videos')
                        .select('*', { count: 'exact', head: true })
                        .eq('folder_type', 'niche')
                        .eq('niche_id', folder.niche_id);
                    videoCount = count || 0;
                } else {
                    const { count } = await supabaseClient
                        .from('videos')
                        .select('*', { count: 'exact', head: true })
                        .eq('folder_type', folder.type);
                    videoCount = count || 0;
                }

                return `
                    <button
                        onclick="${!isLocked ? `selectFolder('${folder.id}', '${folder.type}', '${folder.niche_id || ''}')` : ''}"
                        class="p-6 border-2 rounded-xl text-left transition ${
                            isLocked ? 
                            'border-gray-300 bg-gray-100 opacity-60 cursor-not-allowed' :
                            'border-gray-300 hover:border-secondary hover:shadow-lg'
                        }"
                        ${isLocked ? 'disabled' : ''}
                    >
                        <div class="flex items-start justify-between mb-2">
                            <h3 class="text-xl font-bold text-primary flex items-center gap-2">
                                üìÅ ${folder.name}
                                ${isLocked ? '<span class="text-2xl">üîí</span>' : ''}
                            </h3>
                        </div>
                        ${isLocked ? `
                            <p class="text-sm text-gray-600 italic">${lockMessage}</p>
                        ` : `
                            <p class="text-sm text-gray-600">${videoCount} video${videoCount !== 1 ? 's' : ''}</p>
                        `}
                    </button>
                `;
            }));

            const showNicheModal = welcomeComplete && basicsComplete && !currentProfile.niche_id;

            return `
                <div class="max-w-7xl mx-auto p-6">
                    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6 border-l-4 border-primary">
                        <h2 class="text-2xl font-bold text-primary mb-2">¬°Hola, ${firstName}!</h2>
                        <p class="text-gray-600">Explora tus carpetas de capacitaci√≥n</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${foldersHTML.join('')}
                    </div>

                    ${showNicheModal ? `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-4xl w-full border-t-4 border-primary max-h-[90vh] overflow-y-auto">
                                <h2 class="text-3xl font-bold text-primary mb-4">¬°Felicidades, ${firstName}!</h2>
                                <p class="text-gray-600 mb-8">Has completado la capacitaci√≥n b√°sica. Ahora selecciona tu nicho de especializaci√≥n:</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${NICHES.map(niche => `
                                        <button onclick="selectNiche('${niche.id}')" 
                                            class="p-6 border-2 border-gray-300 rounded-xl text-left hover:border-secondary hover:bg-accent hover:bg-opacity-20 transition">
                                            <h3 class="font-semibold text-lg text-primary">${niche.name}</h3>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function renderFolderVideos(folder) {
            let query = supabaseClient
                .from('videos')
                .select('*')
                .eq('folder_type', folder.type)
                .order('order_index');

            if (folder.type === 'niche') {
                query = query.eq('niche_id', folder.niche_id);
            }

            const { data: videos, error } = await query;

            if (error) {
                console.error('Error loading videos:', error);
                return `
                    <div class="max-w-6xl mx-auto p-6">
                        <div class="bg-white rounded-2xl shadow-xl p-8">
                            <button onclick="closeFolder()" class="mb-4 text-secondary hover:text-primary font-semibold">
                                ‚Üê Volver a carpetas
                            </button>
                            <div class="bg-red-50 border-l-4 border-red-500 p-4">
                                <p class="text-red-800">Error al cargar videos</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (!videos || videos.length === 0) {
                return `
                    <div class="max-w-6xl mx-auto p-6">
                        <div class="bg-white rounded-2xl shadow-xl p-8">
                            <button onclick="closeFolder()" class="mb-4 text-secondary hover:text-primary font-semibold flex items-center gap-2">
                                ‚Üê Volver a carpetas
                            </button>
                            <h2 class="text-2xl font-bold text-primary mb-4">üìÅ ${folder.name}</h2>
                            <div class="bg-blue-50 border-l-4 border-secondary p-4">
                                <p class="text-primary">üìπ Esta carpeta a√∫n no tiene videos. El administrador los agregar√° pronto.</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            const { data: progressData } = await supabaseClient
                .from('video_progress')
                .select('*')
                .eq('user_id', currentProfile.id);

            const progressMap = {};
            if (progressData) {
                progressData.forEach(p => progressMap[p.video_id] = p);
            }

            let currentVideoIndex = 0;
            for (let i = 0; i < videos.length; i++) {
                if (!progressMap[videos[i].id]?.completed) {
                    currentVideoIndex = i;
                    break;
                }
                if (i === videos.length - 1) currentVideoIndex = i;
            }

            const currentVideo = videos[currentVideoIndex];

            const videosListHTML = videos.map((video, index) => {
                const isCompleted = progressMap[video.id]?.completed;
                const isCurrent = currentVideo.id === video.id;
                
                return `
                    <button
                        onclick="selectVideo('${video.id}')"
                        class="p-4 border-2 rounded-lg text-left transition ${
                            isCurrent ? 'border-secondary bg-accent bg-opacity-20' :
                            isCompleted ? 'border-green-500 bg-green-50' :
                            'border-gray-300 hover:border-secondary'
                        }"
                    >
                        <div class="flex items-center justify-between">
                            <span class="font-medium">${video.title}</span>
                            ${isCompleted ? '<span class="text-green-500 text-xl">‚úì</span>' : ''}
                        </div>
                    </button>
                `;
            }).join('');

            setTimeout(() => {
                initVideoTracking(currentVideo.id);
            }, 500);

            return `
                <div class="max-w-6xl mx-auto p-6">
                    <div class="bg-white rounded-2xl shadow-xl p-8">
                        <button onclick="closeFolder()" class="mb-4 text-secondary hover:text-primary font-semibold flex items-center gap-2">
                            ‚Üê Volver a carpetas
                        </button>
                        
                        <h2 class="text-2xl font-bold text-primary mb-6">üìÅ ${folder.name}</h2>
                        
                        <div class="mb-6">
                            <div class="aspect-video bg-gray-900 rounded-lg mb-4 overflow-hidden">
                                <iframe
                                    id="video-player-${currentVideo.id}"
                                    src="https://drive.google.com/file/d/${currentVideo.drive_file_id}/preview"
                                    class="w-full h-full"
                                    style="width: 100%; height: 100%; border: none;"
                                    allow="autoplay"
                                ></iframe>
                            </div>
                            <h3 class="text-xl font-semibold text-primary mb-2">${currentVideo.title}</h3>
                            <p class="text-gray-600 mb-4">${currentVideo.description || ''}</p>
                            
                            ${progressMap[currentVideo.id]?.completed ? `
                                <div class="flex items-center gap-2 text-green-600">
                                    <span class="text-2xl">‚úì</span>
                                    <span class="font-semibold">Video completado</span>
                                </div>
                            ` : `
                                <div class="flex items-center gap-2 text-blue-600">
                                    <div class="animate-pulse">‚èØÔ∏è</div>
                                    <span>Mira el video hasta el 90% para marcarlo como completado</span>
                                </div>
                            `}
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${videosListHTML}
                        </div>
                    </div>
                </div>
            `;
        }

        function initVideoTracking(videoId) {
            if (videoProgressTracking[videoId]) return;

            const iframe = document.getElementById(`video-player-${videoId}`);
            if (!iframe) return;

            videoProgressTracking[videoId] = {
                startTime: Date.now(),
                checking: true
            };

            const checkInterval = setInterval(async () => {
                if (!videoProgressTracking[videoId]?.checking) {
                    clearInterval(checkInterval);
                    return;
                }

                const elapsedSeconds = (Date.now() - videoProgressTracking[videoId].startTime) / 1000;
                
                if (elapsedSeconds >= 162) {
                    clearInterval(checkInterval);
                    await markVideoComplete(videoId);
                }
            }, 5000);
        }

        async function markVideoComplete(videoId) {
            try {
                const { error } = await supabaseClient
                    .from('video_progress')
                    .upsert({
                        user_id: currentProfile.id,
                        video_id: videoId,
                        progress_percent: 100,
                        completed: true
                    });
                
                if (error) throw error;
                
                if (videoProgressTracking[videoId]) {
                    videoProgressTracking[videoId].checking = false;
                }
                
                render();
            } catch (error) {
                console.error('Error marking video as complete:', error);
            }
        }

        window.selectFolder = function(folderId, folderType, nicheId) {
            const folder = FOLDERS.find(f => f.id === folderId);
            if (folder) {
                selectedFolder = { ...folder };
            } else if (folderId === 'niche') {
                const niche = NICHES.find(n => n.id === nicheId);
                selectedFolder = {
                    id: 'niche',
                    name: niche.folder,
                    type: 'niche',
                    niche_id: nicheId
                };
            }
            render();
        };

        window.selectVideo = function(videoId) {
            Object.keys(videoProgressTracking).forEach(key => {
                if (videoProgressTracking[key]) {
                    videoProgressTracking[key].checking = false;
                }
            });
            
            render();
        };

        window.closeFolder = function() {
            Object.keys(videoProgressTracking).forEach(key => {
                if (videoProgressTracking[key]) {
                    videoProgressTracking[key].checking = false;
                }
            });
            
            selectedFolder = null;
            render();
        };

        function renderAdmin() {
            return `
                <div class="max-w-7xl mx-auto p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <button onclick="showAdminView('users')" class="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition border-t-4 border-primary">
                            <h3 class="text-xl font-bold text-primary mb-2">üë• Gesti√≥n de Usuarios</h3>
                            <p class="text-gray-600">Ver y administrar usuarios</p>
                        </button>
                        <button onclick="showAdminView('videos')" class="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition border-t-4 border-secondary">
                            <h3 class="text-xl font-bold text-primary mb-2">üé¨ Gesti√≥n de Videos</h3>
                            <p class="text-gray-600">Agregar y administrar videos</p>
                        </button>
                        <button onclick="toggleViewAsAgent()" class="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition border-t-4 border-highlight">
                            <h3 class="text-xl font-bold text-primary mb-2">üëÅÔ∏è Ver como Agente</h3>
                            <p class="text-gray-600">Previsualizar la experiencia</p>
                        </button>
                    </div>
                    <div id="admin-content" class="bg-white rounded-2xl shadow-xl p-8 border-l-4 border-primary">
                        <h2 class="text-2xl font-bold text-primary mb-4">Panel de Administraci√≥n</h2>
                        <p class="text-gray-600">Selecciona una opci√≥n arriba para comenzar.</p>
                    </div>
                </div>
            `;
        }

        async function showAdminView(view) {
            const content = document.getElementById('admin-content');
            if (view === 'users') {
                const { data: users } = await supabaseClient.from('profiles').select('*').order('created_at', { ascending: false });
                const usersHTML = users ? users.map(user => {
                    const niche = NICHES.find(n => n.id === user.niche_id);
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4">${user.email}</td>
                            <td class="p-4"><span class="px-3 py-1 rounded-full text-sm font-medium ${user.role === 'admin' ? 'bg-highlight text-primary' : 'bg-accent text-primary'}">${user.role}</span></td>
                            <td class="p-4">${niche?.name || 'Sin asignar'}</td>
                            <td class="p-4 text-sm text-gray-500">${new Date(user.created_at).toLocaleDateString()}</td>
                        </tr>
                    `;
                }).join('') : '';
                content.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 text-primary">Gesti√≥n de Usuarios</h2>
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2">
                                <th class="text-left p-4">Email</th>
                                <th class="text-left p-4">Rol</th>
                                <th class="text-left p-4">Nicho</th>
                                <th class="text-left p-4">Fecha</th>
                            </tr>
                        </thead>
                        <tbody>${usersHTML}</tbody>
                    </table>
                `;
            } else if (view === 'videos') {
                const { data: videos } = await supabaseClient.from('videos').select('*').order('order_index');
                const videosHTML = videos && videos.length > 0 ? videos.map(video => {
                    const niche = NICHES.find(n => n.id === video.niche_id);
                    return `
                        <div class="border rounded-lg p-4 hover:bg-gray-50">
                            <div class="flex justify-between">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-lg">${video.title}</h3>
                                    <p class="text-sm text-gray-600">${video.description || ''}</p>
                                    <div class="flex gap-4 text-sm text-gray-500 mt-2">
                                        <span>Tipo: ${video.folder_type}</span>
                                        ${video.niche_id ? `<span>Nicho: ${niche?.name}</span>` : ''}
                                        <span>Orden: ${video.order_index}</span>
                                    </div>
                                </div>
                                <button onclick="deleteVideo('${video.id}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('') : '<p class="text-gray-500">No hay videos.</p>';
                const nichesOpts = NICHES.map(n => `<option value="${n.id}">${n.name}</option>`).join('');
                content.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6 text-primary">Agregar Nuevo Video</h2>
                    <form onsubmit="handleAddVideo(event)" class="mb-8 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">T√≠tulo</label>
                                <input type="text" id="video-title" required class="w-full px-4 py-2 border rounded-lg" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">ID de Drive</label>
                                <input type="text" id="video-drive-id" required class="w-full px-4 py-2 border rounded-lg" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Tipo</label>
                                <select id="video-folder-type" onchange="toggleNicheField()" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="welcome">Bienvenida</option>
                                    <option value="basics">B√°sico</option>
                                    <option value="niche">Nicho</option>
                                    <option value="general">General</option>
                                </select>
                            </div>
                            <div id="niche-field" style="display:none;">
                                <label class="block text-sm font-medium mb-2">Nicho</label>
                                <select id="video-niche" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">Seleccionar...</option>
                                    ${nichesOpts}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Orden</label>
                                <input type="number" id="video-order" value="1" class="w-full px-4 py-2 border rounded-lg" />
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Descripci√≥n</label>
                            <textarea id="video-description" rows="3" class="w-full px-4 py-2 border rounded-lg resize-none"></textarea>
                        </div>
                        <button type="submit" class="px-6 py-3 bg-secondary text-white rounded-lg font-semibold hover:bg-primary">
                            Agregar Video
                        </button>
                    </form>
                    <h2 class="text-2xl font-bold mb-6 text-primary">Videos Existentes</h2>
                    <div class="space-y-4">${videosHTML}</div>
                `;
            }
        }

        window.toggleNicheField = () => {
            const nicheField = document.getElementById('niche-field');
            nicheField.style.display = document.getElementById('video-folder-type').value === 'niche' ? 'block' : 'none';
        };

        window.handleAddVideo = async (e) => {
            e.preventDefault();
            const video = {
                title: document.getElementById('video-title').value,
                description: document.getElementById('video-description').value,
                drive_file_id: document.getElementById('video-drive-id').value,
                folder_type: document.getElementById('video-folder-type').value,
                order_index: parseInt(document.getElementById('video-order').value),
                niche_id: document.getElementById('video-niche')?.value || null
            };
            try {
                const { error } = await supabaseClient.from('videos').insert(video);
                if (error) throw error;
                alert('Video agregado');
                showAdminView('videos');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        window.deleteVideo = async (id) => {
            if (!confirm('¬øEliminar video?')) return;
            try {
                await supabaseClient.from('videos').delete().eq('id', id);
                alert('Video eliminado');
                showAdminView('videos');
            } catch (error) {
                alert('Error al eliminar');
            }
        };

        window.handleLoginSubmit = (e) => {
            e.preventDefault();
            handleLogin(document.getElementById('email').value, document.getElementById('password').value);
        };

        window.handleLogout = handleLogout;
        window.goToHome = goToHome;
        window.toggleViewAsAgent = toggleViewAsAgent;
        window.showAdminView = showAdminView;
        
        window.selectNiche = async (nicheId) => {
            try {
                await supabaseClient.from('profiles').update({ niche_id: nicheId }).eq('id', currentProfile.id);
                currentProfile.niche_id = nicheId;
                render();
            } catch (error) {
                alert('Error al actualizar nicho');
            }
        };

        init();
    </script>
</body>
</html>
